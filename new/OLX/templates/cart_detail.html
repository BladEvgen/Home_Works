{% extends "components/base.html" %} {% load django_app_filters_and_tags %} 
{%load static %} {% block main %}
<div class="container mt-5">
  <h2>Your Shopping Cart</h2>

  {% for cart_item in cart_items %}
  <div class="row mb-3">
    <div class="col-md-2">
      <img
        src="{{ cart_item.item.get_image_url }}"
        alt="{{ cart_item.item.title }}"
        class="img-fluid" />
    </div>
    <div class="col-md-4">
      <h4>{{ cart_item.item.title }}</h4>
      {% if cart_item.item.discounted_price %}
      <p class="text-muted">
        Price:
        <del
          >{{ cart_item.item.price }} <i class="fa-solid fa-tenge-sign"></i
        ></del>
      </p>
      <p>
        Discounted Price: {{ cart_item.item.discounted_price }}
        <i class="fa-solid fa-tenge-sign"></i>
      </p>
      {% else %}
      <p>
        Price: {{ cart_item.item.price }} <i class="fa-solid fa-tenge-sign"></i>
      </p>
      {% endif %}
    </div>
    <div class="col-md-2">
      <div class="quantity-container">
        <label for="quantity_{{ cart_item.item.id }}">Quantity:</label>
        <input
          type="number"
          id="quantity_{{ cart_item.item.id }}"
          name="quantity"
          value="{{ cart_item.quantity }}"
          min="1"
          data-item-id="{{ cart_item.item.id }}" />
      </div>
      <p>
        Total:
        <span id="total_price_{{ cart_item.item.id }}"
          >{{ cart_item.calculate_item_total }}</span
        >
      </p>
    </div>
    <div class="col-md-2">
      <form
        method="post"
        action="{% url 'remove_from_cart' cart_item.item.id %}">
        {% csrf_token %}
        <button type="submit" class="btn btn-danger">
          <i class="fas fa-trash"></i> Remove
        </button>
      </form>
    </div>
  </div>
  {% endfor %}

  <div class="checkout-container">
    <div class="row mt-3">
      <div class="col-md-6 offset-md-6">
        <h4 id="total_price">
          Total Price: {{ total_price }} <i class="fa-solid fa-tenge-sign"></i>
        </h4>
        <a href="{% url 'checkout' %}" class="btn btn-primary checkout-button">
          <i class="fas fa-shopping-cart"></i> Checkout
        </a>
      </div>
    </div>
  </div>
</div>
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

<script>
  $(document).ready(function () {
    $('input[name="quantity"]').on("change", function () {
      const itemId = $(this).data("item-id");
      const quantity = $(this).val();

      console.log("Item ID:", itemId);
      console.log("Quantity:", quantity);

      $.ajax({
        type: "POST",
        url: '{% url "update_cart_quantity" item_id=0 %}'.replace("0", itemId),
        data: {
          item_id: itemId,
          quantity: quantity,
          csrfmiddlewaretoken: "{{ csrf_token }}",
        },
        success: function (response) {
          const totalElement = $(`#total_price_${itemId}`);
          totalElement.html(
            response.total.toFixed(2) +
              ' <i class="fa-solid fa-tenge-sign"></i>'
          );

          updateTotalPrice();
        },
        error: function (error) {
          console.log("Error:", error);
        },
      });
    });

    function updateTotalPrice() {
      let totalPrice = 0;
      $('span[id^="total_price_"]').each(function () {
        totalPrice += parseFloat($(this).text());
      });

      $("#total_price").html(
        "Total Price: " +
          totalPrice.toFixed(2) +
          ' <i class="fa-solid fa-tenge-sign"></i>'
      );
    }
  });
</script>
{% endblock main %}
