{% extends "components/base.html" %} {% load django_app_filters_and_tags %} 
{%load static %} {% block main %}
<div class="container mt-5">
  <h2 class="text-center mb-4">Your Shopping Cart</h2>
  {% for cart_item in cart_items %}
    <div class="row mb-4 cart-item">
      <div class="col-md-2">
        <img src="{{ cart_item.item.get_image_url }}" alt="{{ cart_item.item.title }}" class="img-fluid cart-image" />
      </div>
      <div class="col-md-4">
        <h4>{{ cart_item.item.title }}</h4>
        {% if cart_item.item.discounted_price %}
          <p class="text-muted mb-1">
            <del>{{ cart_item.item.price }} <i class="fas fa-tenge-sign"></i></del>
          </p>
          <p class="mb-1">
            <strong>Discounted Price:</strong> {{ cart_item.item.discounted_price }}
            <i class="fas fa-tenge-sign"></i>
          </p>
        {% else %}
          <p class="mb-1">
            <strong>Price:</strong> {{ cart_item.item.price }} <i class="fas fa-tenge-sign"></i>
          </p>
        {% endif %}
      </div>
      <div class="col-md-2">
        <div class="quantity-container">
          <label for="quantity_{{ cart_item.item.id }}">Quantity:</label>
          <input
            type="number"
            id="quantity_{{ cart_item.item.id }}"
            name="quantity"
            value="{{ cart_item.quantity }}"
            min="1"
            data-item-id="{{ cart_item.item.id }}"
            class="form-control quantity-input"
          />
        </div>
      </div>
      <div class="col-md-2">
        <p class="mb-1"><strong>Total:</strong></p>
        <p class="mb-1 total-price" id="total_price_{{ cart_item.item.id }}">
          {{ cart_item.calculate_item_total }}
        </p>
      </div>
      <div class="col-md-2 text-center">
        <form method="post" action="{% url 'remove_from_cart' cart_item.item.id %}">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger remove-btn">
            <i class="fas fa-trash"></i> Remove
          </button>
        </form>
      </div>
    </div>
  {% endfor %}

  <div class="checkout-container text-center mt-4">
    <div class="row">
      <div class="col-md-6 offset-md-6">
        <h4 class="mb-2">
          Total Price: <span id="total_price">{{ total_price }}</span> <i class="fas fa-tenge-sign"></i>
        </h4>
        <a href="{% url 'checkout' %}" class="btn btn-primary checkout-button">
          <i class="fas fa-shopping-cart"></i> Proceed to Checkout
        </a>
      </div>
    </div>
  </div>
</div>
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script>
  $(document).ready(function () {
    $('input[name="quantity"]').on("change", function () {
      const itemId = $(this).data("item-id");
      const quantity = $(this).val();

      $.ajax({
        type: "POST",
        url: '{% url "update_cart_quantity" item_id=0 %}'.replace("0", itemId),
        data: {
          item_id: itemId,
          quantity: quantity,
          csrfmiddlewaretoken: "{{ csrf_token }}",
        },
        success: function (response) {
          const totalElement = $(`#total_price_${itemId}`);
          totalElement.html(response.total.toFixed(2));

          updateTotalPrice();
        },
        error: function (error) {
          console.log("Error:", error);
        },
      });
    });

    function updateTotalPrice() {
      let totalPrice = 0;
      $('p.total-price').each(function () {
        totalPrice += parseFloat($(this).text());
      });

      $("#total_price").text(totalPrice.toFixed(2));
    }
  });
</script>
{% endblock main %}
